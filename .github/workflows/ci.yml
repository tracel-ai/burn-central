name: CI

env:
  CARGO_TERM_COLOR: always

# For now we execute CI only on PR to save on CI time
on:
  pull_request: {}


jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rust
        uses: tracel-ai/github-actions/setup-rust@v3
        with:
          rust-toolchain: stable
          cache-key: stable-linux
      # --------------------------------------------------------------------------------
      - name: Audit
        run: cargo xtask check audit
      # --------------------------------------------------------------------------------
      - name: Format
        shell: bash
        env:
          # work around for colors
          # see: https://github.com/rust-lang/rustfmt/issues/3385
          TERM: xterm-256color
        run: cargo xtask check format
      # --------------------------------------------------------------------------------
      - name: Typos
        uses: tracel-ai/github-actions/check-typos@v1

  lint-checks:
    needs: checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features: [burn_0_19, burn_0_20]
    steps:
      - name: Setup Rust
        uses: tracel-ai/github-actions/setup-rust@v3
        with:
          rust-toolchain: stable
          cache-key: stable-linux-${{ matrix.features }}
      # --------------------------------------------------------------------------------
      - name: Lint (${{ matrix.features }})
        run: cargo xtask check --features ${{ matrix.features }} lint

  doc-checks:
    needs: lint-checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features: [burn_0_19, burn_0_20]
    steps:
      - name: Setup Rust
        uses: tracel-ai/github-actions/setup-rust@v3
        with:
          rust-toolchain: stable
          cache-key: stable-linux-${{ matrix.features }}
      # --------------------------------------------------------------------------------
      - name: Documentation Tests (${{ matrix.features }})
        run: cargo xtask doc --features ${{ matrix.features }} tests

  tests:
    needs: doc-checks
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rust
        uses: tracel-ai/github-actions/setup-rust@v3
        with:
          rust-toolchain: stable
          cache-key: stable-linux
      # --------------------------------------------------------------------------------
      - name: Unit Tests
        run: cargo xtask test unit
      # --------------------------------------------------------------------------------
      - name: Integration Tests
        run: cargo xtask test integration
